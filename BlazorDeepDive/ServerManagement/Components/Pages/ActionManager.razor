@page "/smartconfig"
@rendermode InteractiveServer
@using ServerManagement.Models
@using ServerManagement.Components.Controls

<h3>Demo Application</h3>

<div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
    <FluentButton Style="width:56px;" BackgroundColor="#1976d2" OnClick="@AddAction">
        <FluentIcon Icon="@(Icons.Regular.Size24.AddSquare)" Style="fill:white;" />
    </FluentButton>
</div>

@if (Actions != null && Actions.Count > 0)
{
    @for (int i = 0; i < Actions.Count; i++)
    {
        var action = Actions[i];
        var index = i;

        Console.WriteLine($"→ Rendering ActionConfig {index}: Type={action.Type}");

        <ActionConfig @key="@action"
                      Action="@action"
                      ActionNumber="@(index + 1)"
                      DeleteAction="@(async () => DeleteAction(index))"
                      OnActionChanged="@(async (newAction) => UpdateAction(index, newAction))"
                      CopyAction="@(async (actionToCopy) => CopyActionAsync(actionToCopy))" />
    }
}
else
{
    <p>No actions yet. Click the + button to add one.</p>
}

<div style="display:flex; justify-content:space-between; margin-top:2rem;">
    <FluentButton Style="color:white;" BackgroundColor="#1976d2" OnClick="@Cancel">Cancel</FluentButton>
    <FluentButton Style="color:white;" BackgroundColor="#1976d2" OnClick="@Apply">Apply</FluentButton>
</div>

@code {
    private List<ActionModel> Actions = new();

    protected override void OnInitialized()
    {
        Console.WriteLine("✓ ActionManager Initialized");
        if (Actions.Count == 0)
        {
            AddAction();
        }
    }

    private void AddAction()
    {
        Console.WriteLine("→ AddAction: Creating new EmptyAction");
        var emptyAction = new EmptyAction();
        Actions.Add(emptyAction);
        Console.WriteLine($"✓ AddAction: Action added. Total count: {Actions.Count}");
        StateHasChanged();
        Console.WriteLine("✓ AddAction: StateHasChanged triggered");
    }

    private void DeleteAction(int index)
    {
        Console.WriteLine($"→ DeleteAction: index {index}");
        if (index >= 0 && index < Actions.Count)
        {
            Actions.RemoveAt(index);
            StateHasChanged();
            Console.WriteLine($"✓ DeleteAction: Removed. Count: {Actions.Count}");
        }
    }

    private void UpdateAction(int index, ActionModel newAction)
    {
        Console.WriteLine($"→ UpdateAction: index={index}, oldType={Actions[index].Type}, newType={newAction.Type}");

        if (index >= 0 && index < Actions.Count)
        {
            // IMPORTANT: Replace the reference entirely
            Actions[index] = newAction;

            Console.WriteLine($"✓ UpdateAction: List updated at index {index}");
            Console.WriteLine($"  Current Actions[{index}].Type = {Actions[index].Type}");

            // Force re-render
            StateHasChanged();

            Console.WriteLine($"✓ StateHasChanged triggered");
        }
        else
        {
            Console.WriteLine($"✗ UpdateAction: Invalid index {index}");
        }
    }

    private async Task CopyActionAsync(ActionModel actionToCopy)
    {
        Console.WriteLine($"→ CopyActionAsync: Copying type {actionToCopy.Type}");
        var clonedAction = actionToCopy.Clone();
        Actions.Add(clonedAction);
        StateHasChanged();
        Console.WriteLine($"✓ CopyActionAsync: Cloned and added. Count: {Actions.Count}");
        await Task.CompletedTask;
    }

    private void Cancel()
    {
        Console.WriteLine("→ Cancel clicked");
    }

    private void Apply()
    {
        Console.WriteLine("→ Apply clicked");
        foreach (var (action, idx) in Actions.Select((a, i) => (a, i)))
        {
            Console.WriteLine($"  Action {idx}: Type={action.Type}");
        }
    }
}
